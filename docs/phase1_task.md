# フェーズ 1: コアエンジンとデータフロー タスクリスト

> [!IMPORTANT]
> **テスト要件**: 各チェックリスト項目は、関連するテスト（既存または新規追加）がパスしたことを確認してから完了とし、次の項目に進んでください。

## 1. 入力注入とセレクタ (`core/engine.py`, `core/context.py`)
- [x] **セレクタ解決ロジックの実装**
    - [x] `Context.resolve(value: Any) -> Any` メソッドを追加する。
    - [x] `$node.<TaskName>.output` の解決（`ctx.results` の参照）をサポートする。
    - [x] `$ctx.params.<Key>` の解決をサポートする。
    - [x] `$env.<Key>` の解決（`os.environ` または `ctx.env` の参照）をサポートする。
    - [x] 必要に応じてネストされた参照（例: `$node.A.output.key`）を処理する。
- [x] **エンジンでの入力適用**
    - [x] `Engine._execute_task` を修正し、`task.inputs`（設定由来）を反復処理するようにする。
    - [x] `ctx.resolve()` を使用して各入力値を解決する。
    - [x] 解決された入力を `kwargs` としてタスク関数に渡す。
    - [x] `ctx` 引数注入の下位互換性を維持する。

## 2. 並列実行 (`core/engine.py`)
- [x] **実行ループのリファクタリング**
    - [x] `while len(executed) < len(flow.tasks)` ループを、並列処理に適したグラフ探索またはキューベースのアプローチに置き換える。
    - [x] タスク実行に `concurrent.futures.ThreadPoolExecutor` を使用する。
- [x] **依存関係管理**
    - [x] 「実行可能」なタスク（すべての依存関係が `executed` セットにある）を特定するロジックを実装する。
    - [x] 実行可能なタスクをエグゼキュータに送信する。
    - [x] タスク完了時に `executed` セットを更新し、新たな実行可能タスクを確認する。
- [x] **スレッドセーフ**
    - [x] `Context.results` やその他の共有状態の変更がスレッドセーフであることを確認する（必要に応じて `threading.Lock` を使用）。

## 3. コンテキストの強化 (`core/context.py`)
- [x] **アーティファクトストレージ**
    - [x] `Context` に `artifact_dir` を追加する。
    - [x] `save_artifact(name, data)` メソッドを実装する。
        - [x] 非プリミティブなオブジェクトは `str()` で文字列化して保存する。
    - [x] `Task` モデルに `save` 設定を追加し、`Engine` で実行後に自動保存するロジックを実装する。
- [x] **セレクタ解決のためのヘルパーメソッド**
    - [x] (済) `resolve` メソッドは実装済み。。
    - [x] 大きなアーティファクト用のファイルシステムストレージを実装する（MVPではオプションだが、構造は用意する）。
    - [x] `ctx.artifacts` 辞書を更新する。
- [x] **保存設定のサポート**
    - [x] `Engine` 内で、タスク実行後に `task.save` 設定を処理する。
    - [x] 指定に従って出力を `ctx` パスまたはアーティファクトに保存する。
