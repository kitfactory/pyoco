# v0.3.0 Design: Kanban Server & Workers

This document defines the user experience, CLI interfaces, and architecture for Pyoco v0.3.0. The goal is to introduce asynchronous execution and remote management while maintaining the simplicity of the "Cute" experience.

## 1. Architecture Overview

v0.3.0 introduces two new long-running processes:

1.  **Kanban Server**: A lightweight HTTP server (FastAPI) that acts as the central coordinator.
    -   **Registry**: Stores `RunContext` and `TaskState` (in-memory or SQLite).
    -   **Queue**: Holds pending run requests.
    -   **API**: Provides endpoints for submission, status query, and cancellation.
2.  **Worker**: A process that pulls run requests from the Server and executes them using the existing `Engine`.

## 2. User Experience & CLI

### 2.1 Starting the Infrastructure

**Start the Server:**
```bash
pyoco server start --port 8000
# üêá pyoco server listening on http://localhost:8000
```

**Start a Worker:**
```bash
pyoco worker start --server http://localhost:8000 --tags "gpu,high-mem"
# üêú pyoco worker started. Connected to http://localhost:8000
```

**Stopping:**
Both Server and Worker run in the foreground. To stop them, simply press `Ctrl+C`.
-   **Server**: Shuts down the API and stops accepting new requests. State (in-memory) is lost.
-   **Worker**: Finishes the currently running task (graceful shutdown) before exiting.

### 2.2 Submitting Workflows

Users can submit flows to the queue instead of running them locally.

**Local Execution (Existing):**
```bash
pyoco run --config flow.yaml --flow my_flow
```

**Remote Execution (New):**
```bash
pyoco run --config flow.yaml --flow my_flow --server http://localhost:8000
# üöÄ Flow submitted! Run ID: a1b2c3d4
# üìã View status: pyoco runs show a1b2c3d4
```

*Note: Specifying `--server` automatically implies remote execution. The flow definition and parameters are sent to the server.*

### 2.3 Observability (The "Kanban" View)

**List Runs:**
```bash
pyoco runs list
# üêá Active Runs:
# ID        | Flow         | Status    | Worker | Duration
# ----------+--------------+-----------+--------+---------
# a1b2c3d4  | my_flow      | RUNNING   | w-1    | 12s
# e5f6g7h8  | data_pipeline| PENDING   | -      | -
```

**Show Run Details:**
```bash
pyoco runs show a1b2c3d4
# üêá Run: a1b2c3d4 (my_flow)
# Status: RUNNING
# Worker: w-1
#
# Tasks:
#   [‚úÖ] fetch_data
#   [üîÑ] process_data
#   [‚è≥] save_result
```

### 2.4 Control

**Cancel a Run:**
```bash
pyoco runs cancel a1b2c3d4
# üõë Cancellation requested for run a1b2c3d4.
```

## 3. API Specification (Draft)

### `POST /runs`
- **Body**: `{ flow_name: str, params: dict, tags: list }`
- **Response**: `{ run_id: str, status: "PENDING" }`

### `GET /runs`
- **Query**: `status` (optional)
- **Response**: `[ { run_id, flow_name, status, ... } ]`

### `GET /runs/{run_id}`
- **Response**: `RunContext` (including task states)

### `POST /runs/{run_id}/cancel`
- **Response**: `{ status: "CANCELLING" }`

### `POST /workers/poll` (Internal)
- **Body**: `{ worker_id: str, tags: list }`
- **Response**: `{ run_id: str, flow_name: str, params: dict }` or `null`

### `POST /runs/{run_id}/heartbeat` (Internal)
- **Body**: `{ task_states: dict, run_status: str }`
- **Response**: `{ cancel_requested: bool }`

## 4. Implementation Strategy

1.  **Server Implementation**:
    -   Use `FastAPI` for the server.
    -   Implement in-memory `StateStore` and `Queue`.
2.  **Worker Implementation**:
    -   Implement a polling loop.
    -   Reuse `Engine` but wrap it to send heartbeats/state updates to the server.
3.  **CLI Updates**:
    -   Add `server`, `worker`, `runs` subcommands.
    -   Update `run` command: if `--server` is present, submit to API instead of running locally.

## 5. Open Questions / Constraints for v0.3.0

-   **Code Distribution**: How does the worker get the task code?
    -   *Decision*: For v0.3.0, we assume **Shared Environment**. The worker must be running in an environment where the task code is importable (e.g., same repo, or installed package). The `flow.yaml` content might need to be sent, or just the flow name if the worker can load the config.
    -   *Proposal*: Send the `flow.yaml` content (or path if shared) in the submit request.
-   **Persistence**:
    -   *Decision*: In-memory only for v0.3.0. Restarting the server loses state.
