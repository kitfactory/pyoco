# v0.4.0 Tasks

設計ドキュメントで定義した機能をエピック単位で分割し、各要素ごとに単体テスト→テストパス確認→次タスク着手という順で進める。最後に全体回帰テストとDry Runを実行する。

## 1. DSL 拡張

### 1.1 AST/DSL インフラ
- [ ] `pyoco.dsl` に `RepeatNode`, `ForEachNode`, `UntilNode`, `SwitchNode`, `CaseNode`, `SubFlowNode` を追加。
- [ ] `task.FlowFragment` 的な構造に `__getitem__`, `__mod__`, `__rrshift__` を実装。
- [ ] `switch(expr)` ビルダーの作成と `CaseNode` 取り回し。
- **Unit Test**: `tests/dsl/test_nodes.py` で AST 生成と演算子を検証し `pytest tests/dsl/test_nodes.py` をパスする。

### 1.2 値参照パーサ
- [ ] `$ctx` / `$env` 参照パーサを強化し、設計に沿った構文のみ許可。
- [ ] 式コンパイルのキャッシュと `ExpressionEvaluationError` 追加。
- **Unit Test**: `tests/dsl/test_expression.py` を作成し、正常系/異常系を網羅 → `pytest tests/dsl/test_expression.py`。

### 1.3 LoopContext
- [ ] `LoopContext`/`LoopStack` のデータ構造と `ctx.loop`/`ctx.loops` へのエクスポート。
- [ ] ループでの push/pop/metadata 更新を実装。
- **Unit Test**: `tests/core/test_loop_context.py` で push/pop, nested path などを検証。

## 2. エンジン対応

### 2.1 Repeat/ForEach 実行
- [ ] Engine の DAG traversal を拡張し、Repeat/ForEach ノードを展開せずランタイムで実行。
- [ ] ForEach の alias, iterable バリデーション, sequential 実行を実装。
- **Unit Test**: `tests/engine/test_loop_execution.py` に repeat/foreach の実行テストを追加。`pytest tests/engine/test_loop_execution.py`。

### 2.2 Until 実行
- [ ] `UntilNode` の do-while semantics, `max_iter`, `UntilMaxIterationsExceeded` を実装。
- [ ] ループ内の失敗時に即座にエラーを propagate。
- **Unit Test**: 同ファイルで until テスト（成功/条件成立/最大回数超過）。

### 2.3 Switch 実行
- [ ] `SwitchNode` で条件評価→ケース選択→ブランチ実行。
- [ ] `SwitchNoMatch` 警告イベントと default case の扱い。
- **Unit Test**: `tests/engine/test_switch.py` に分岐テストを追加。

### 2.4 Dry Run 検証
- [ ] すべての control-flow ノードに `validate(ctx)` 実装。
- [ ] `pyoco check --dry-run` コマンドで新しい警告/エラーを出力。
- **Unit Test**: `tests/cli/test_check.py` で CLI からの dry-run 結果を検証。

## 3. デバッグ / 観測機能

### 3.1 RunContext 拡張
- [ ] `RunContext` に stack trace, inputs, outputs, metadata, sensitive フラグ処理を実装。
- [ ] 保持ポリシー設定 & spill to disk 機構。
- **Unit Test**: `tests/server/test_run_store.py` で CRUD と redaction を確認。

### 3.2 ログキャプチャ
- [ ] Worker で stdout/stderr をキャプチャし chunk schema で送信。
- [ ] Server 側の API (`/runs/<id>/logs`) を実装、backpressure 対応。
- **Unit Test**: `tests/server/test_logs.py` で chunk の保存と backpressure の挙動。

### 3.3 CLI ツール
- [ ] `pyoco runs inspect` に JSON 出力とスタックトレース表示を追加。
- [ ] `pyoco runs logs` に `--task`, `--tail`, `--follow`, `--allow-failure` を実装。
- **Unit Test**: `tests/cli/test_runs.py` で CLI の表示と exit code を検証。

## 4. テスト計画

1. 各サブタスクで指定した単体テストファイルを追加/更新し、`pytest <target>` でパスを確認してから次に進む。
2. エピック完了後、関連モジュールの結合テスト（例: `tests/examples/test_flows.py` に loop/switch 実例）を追加し `pytest tests/examples/test_flows.py` を実行。
3. リリース前にフルスイートを実行: `pytest`.
4. CLI コマンド系は `pyoco check --dry-run examples/hello_pyoco.py` 的なスモークも実施しログで成功を確認。
