# v0.4.0 Tasks

設計ドキュメントで定義した機能をエピック単位で分割し、各要素ごとに単体テスト→テストパス確認→次タスク着手という順で進める。最後に全体回帰テストとDry Runを実行する。

## 1. DSL 拡張

### 1.1 AST/DSL インフラ
- [x] `pyoco.dsl` に `RepeatNode`, `ForEachNode`, `UntilNode`, `SwitchNode`, `CaseNode`, `SubFlowNode` を追加。
- [x] `task.FlowFragment` 的な構造に `__getitem__`, `__mod__`, `__rrshift__` を実装。
- [x] `switch(expr)` ビルダーの作成と `CaseNode` 取り回し。
- **Unit Test**: `tests/dsl/test_nodes.py` で AST 生成と演算子を検証し `PYTHONPATH=src pytest tests/test_dsl.py tests/dsl/test_branching.py tests/dsl/test_nodes.py`。

### 1.2 値参照パーサ
- [x] `$ctx` / `$env` 参照パーサを強化し、設計に沿った構文のみ許可。
- [x] 式コンパイルのキャッシュと `ExpressionEvaluationError` 追加。
- **Unit Test**: `tests/dsl/test_expression.py` を作成し、正常系/異常系を網羅 → `PYTHONPATH=src pytest tests/dsl/test_expression.py`。

### 1.3 LoopContext
- [x] `LoopContext`/`LoopStack` のデータ構造と `ctx.loop`/`ctx.loops` へのエクスポート。
- [x] ループでの push/pop/metadata 更新を実装。
- **Unit Test**: `tests/core/test_loop_context.py` で push/pop, nested path などを検証 → `PYTHONPATH=src pytest tests/core/test_loop_context.py`。

## 2. エンジン対応

### 2.1 Repeat/ForEach 実行
- [x] Engine の DAG traversal を拡張し、Repeat/ForEach ノードを展開せずランタイムで実行。
- [x] ForEach の alias, iterable バリデーション, sequential 実行を実装。
- **Unit Test**: `tests/engine/test_loop_execution.py` に repeat/foreach の実行テストを追加。`PYTHONPATH=src pytest tests/test_dsl.py tests/dsl/test_branching.py tests/dsl/test_nodes.py tests/dsl/test_expression.py tests/core/test_loop_context.py tests/engine/test_loop_execution.py`。

### 2.2 Until 実行
- [x] `UntilNode` の do-while semantics, `max_iter`, `UntilMaxIterationsExceeded` を実装。
- [x] ループ内の失敗時に即座にエラーを propagate。
- **Unit Test**: `tests/engine/test_loop_execution.py` に until ケースを追加。`PYTHONPATH=src pytest tests/engine/test_loop_execution.py`（フルDSLスイート連動）。

### 2.3 Switch 実行
- [x] `SwitchNode` で条件評価→ケース選択→ブランチ実行。
- [x] default case のフォールバックを実装。
- **Unit Test**: `tests/engine/test_switch.py` で分岐テストを追加。`PYTHONPATH=src pytest tests/engine/test_switch.py`（フルDSLスイート連動）。

### 2.4 Dry Run 検証
- [x] すべての control-flow ノードを巡回する `FlowValidator` を実装し、`Until` の `max_iter` 警告や `switch` ケース重複などを検知。
- [x] `pyoco check --dry-run [--json]` でレポートを返すよう CLI を更新（Exit code: 0/2/3）。
- **Unit Test**: `tests/dsl/test_validator.py` と `tests/cli/test_cli.py::test_cli_check_dry_run_*` で検証 (`PYTHONPATH=src pytest tests/dsl/test_validator.py tests/cli/test_cli.py`)。

## 3. デバッグ / 観測機能

### 3.1 RunContext 拡張
- [x] `RunContext` に stack trace, inputs, outputs, metadata 記録とログ蓄積を実装。
- [x] 保持ポリシー設定 & spill to disk 機構（StateStoreで最大件数超過時に `artifacts/runs/*.json` へ退避）。
- **Unit Test**: `tests/core/test_run_context.py` および `tests/server/test_api.py::test_run_retention_spills_to_disk`。

### 3.2 ログキャプチャ
- [x] Worker/Engine で stdout/stderr をキャプチャし chunk schema で送信。
- [x] Server 側の API (`/runs/<id>/logs`) と backpressure（タスク毎 1MB 上限）を実装。
- **Unit Test**: `tests/server/test_api.py::test_logs_endpoint`, `test_log_backpressure`。

### 3.3 CLI ツール
- [x] `pyoco runs inspect` に JSON 出力とタスク詳細表示を追加。
- [x] `pyoco runs logs` に `--task`, `--tail`, `--follow`, `--allow-failure` を実装。
- **Unit Test**: `tests/cli/test_cli.py::test_cli_runs_inspect_json` / `test_cli_runs_logs_tail` で検証。

## 4. テスト計画

[x] 各サブタスクで指定した単体テストファイルを追加/更新し、`pytest <target>` でパスを確認してから次に進む。
[x] エピック完了後は下記の分割テストを順に実行し、Codex 環境でも確実に完走させる（`.venv/bin/python -m pytest` を必ず使用する）:
   - DSL・基礎: `PYTHONPATH=src .venv/bin/python -m pytest tests/dsl/test_expression.py tests/dsl/test_nodes.py tests/dsl/test_validator.py tests/core/test_loop_context.py tests/core/test_run_context.py`
   - エンジン: `PYTHONPATH=src .venv/bin/python -m pytest tests/engine/test_loop_execution.py tests/engine/test_switch.py`
   - CLI: `PYTHONPATH=src .venv/bin/python -m pytest tests/cli/test_cli.py`
   - サーバAPI: `PYTHONPATH=src .venv/bin/python -m pytest tests/server/test_api.py::test_submit_run tests/server/test_api.py::test_list_runs tests/server/test_api.py::test_get_run`
   - サーバAPI（ログ/リテンション系）: `PYTHONPATH=src .venv/bin/python -m pytest tests/server/test_api.py::test_worker_poll tests/server/test_api.py::test_worker_heartbeat_and_cancel tests/server/test_api.py::test_logs_endpoint tests/server/test_api.py::test_log_backpressure tests/server/test_api.py::test_run_retention_spills_to_disk`
   - Socketless サンプル: `PYTHONPATH=src .venv/bin/python -m pytest tests/test_socketless_basic.py`
   - Socketless E2E（Worker/Client）: `PYTHONPATH=src .venv/bin/python -m pytest tests/test_e2e_socketless.py`
   - 既存の統合テスト: `PYTHONPATH=src .venv/bin/python -m pytest tests/test_integration_v030.py`
[x] 上記が通ったら最終確認として `PYTHONPATH=src .venv/bin/python -m pytest` を実行し、全体の回帰を取る。
[x] CLI コマンド系は `pyoco check --dry-run examples/hello_pyoco.py` 的なスモークも実施しログで成功を確認。
