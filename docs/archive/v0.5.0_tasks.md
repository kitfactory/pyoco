# v0.5.0 Tasks

メインテーマ: 観測ブリッジ (Grafana/Prometheus/Webhook) と Task Plug-in System。
各項目で実装 → 対応テストを `.venv/bin/python -m pytest ...` で実行し、パスを確認してから次に進む。

## 1. 観測ブリッジ

### 1.1 Prometheus メトリクス
- [x] `/metrics` エンドポイントを追加し、下記メトリクスを配信。
  - `pyoco_runs_total{status}`
  - `pyoco_runs_in_progress`
  - `pyoco_task_duration_seconds{task}` (Histogram)
  - `pyoco_run_duration_seconds{flow}` (Histogram)
- [x] StateStore/Engine からメトリクス更新ロジックを実装。
- **Test**: `PYTHONPATH=src .venv/bin/python -m pytest tests/observability/test_metrics.py` ✅

### 1.2 REST API 拡張
- [x] `/runs` に `status`, `flow`, `limit` パラメータ追加。`/runs/{run_id}` にタスク所要時間情報を含める。
- [x] `/runs/{run_id}/logs` に `?tail=` オプション追加。
- **Test**: `PYTHONPATH=src .venv/bin/python -m pytest tests/server/test_api_observability.py` ✅

### 1.3 Webhook 通知
- [x] Run が FAILED/COMPLETED になる際に JSON を送る Webhook 設定を追加。
- [x] 失敗時のリトライ/タイムアウトを含めたシンプルな実装。
- **Test**: `PYTHONPATH=src .venv/bin/python -m pytest tests/server/test_webhook.py` ✅

### 1.4 Grafana テンプレート
- [x] Prometheus/REST API を利用する Grafana JSON テンプレートを作成し、docs に配置。
- [x] README(v0.5)にテンプレロード手順を記載。
- **Test**: 手動確認 (JSON validator / import 手順) を記録。

## 2. Task Plug-in System

### 2.1 Entry-point ローダー
- [x] TaskLoader に `importlib.metadata.entry_points(group="pyoco.tasks")` の読込処理を実装。
- [x] EntryPoint のロードシグネチャ (`def register_tasks(registry)`) を実装・ドキュメント化。
- [x] エラー時に警告を出すだけで pyoco を停止させない。
- **Test**: `PYTHONPATH=src .venv/bin/python -m pytest tests/plugins/test_entrypoint_loader.py` ✅

### 2.2 開発ガイド & CLI ヘルパー
- [x] `docs/plugins.md` を作成し、pyproject.toml 設定例・skeleton を記載。
- [x] (任意) `pyoco plugins list` CLI を追加し、発見したプラグインを表示。
- **Test**: `PYTHONPATH=src .venv/bin/python -m pytest tests/cli/test_cli.py::test_cli_plugins_list` ✅

## 3. テスト計画まとめ
- [x] 各サブタスクのテストを `.venv/bin/python -m pytest` で個別に実行し、パスを確認。
- [x] 観測系/Plug-in 系が通ったら `PYTHONPATH=src .venv/bin/python -m pytest tests/observability tests/plugins` をまとめて実行。
- [x] 最終回帰: `PYTHONPATH=src .venv/bin/python -m pytest`。
