# v0.5.0 Design: Observability & Plug-in Extensibility

## Theme
Keep pyoco lightweight while letting external tools provide visibility and domain-specific tasks. v0.5.0 focuses on

1. **Observability Bridge**: Expose metrics/events so Grafana/Prometheus/Webhook consumers can watch runs and errors without pyoco having to ship a full monitoring stack.
2. **Task Plug-in System**: Allow third-party packages to register tasks via entry points (`pyoco.tasks`). pyoco discovers these tasks automatically, so external domain packages (vision/ML/etc.) can extend the engine without patching the core.

## 1. Observability Bridge

### Goals
- まずは「実行中一覧／完了一覧／個別Runの状態」を外部監視ツールで見られる最低限の情報を提供する。
- Grafanaを想定し、Prometheusメトリクスと `/runs` REST API を整備する。
- サンプルダッシュボードJSON（テンプレート）を付属し、すぐ可視化できるようにする。

### Primary Observability Use Cases
1. **実行中タスク一覧**: 依頼したRunが今動いているか（`pyoco_runs_in_progress`と`/runs?status=RUNNING`）。
2. **完了/失敗タスク一覧**: 最近終わったRunと失敗率の俯瞰（`increase(pyoco_runs_total{status!="PENDING"})`）。
3. **個別Runの進捗・所要時間**: `/runs/{run_id}` の `task_summary` と `pyoco_run_duration_seconds` を組み合わせる。
4. **エラー通知**: WebhookでFAILED/COMPLETEDイベントをSlackなどへ送信。
5. **ログ確認**: `/runs/{id}/logs?tail=N` を使って直近のログ断片をダッシュボードから呼び出す。

### Proposed Work
1. **Prometheus metrics endpoint**
   - `/metrics` でカウンタ/ゲージ: `pyoco_runs_total{status=...}`, `pyoco_runs_in_progress`, `pyoco_task_duration_seconds{task=...}`, `pyoco_run_duration_seconds{flow=...}` 等、実行中/完了/失敗を把握するのに必要な最小セット。
   - StateStore/Engine から実行開始/完了時に更新。
2. **REST API upgrades**
   - `/runs` に `status`, `flow`, `limit` パラメータを追加し、「実行中」「失敗のみ」などを取得可能に。
   - `/runs/{run_id}` で各タスクのステータス・所要時間を返す（既存情報を整形）。
   - `/runs/{run_id}/logs` に `?tail=` などシンプルな絞り込みをつける。
3. **テンプレートダッシュボード**
   - 上記メトリクス/API を利用した簡易Grafana JSON（実行中一覧、完了一覧、指定ID詳細）を同梱し、pyocoらしいキュートな配色（ラベンダー＋キャロットオレンジなど）で仕上げたプリセットを提供。
   - `docs/grafana_pyoco_cute.json` は `Runs in progress` スタット、`Run completions (last 5m)` タイムシリーズ、`Average run duration by flow` テーブルの3枚構成。背景はダークテーマ、色は `#cdb4db` と `#ffafcc/#ffb562` を基調にして「かわいさ」を演出。
4. **Webhook通知 (任意設定)**
   - Runが FAILED/COMPLETED になった際にJSONをPOSTする設定フックを提供し、Slack等に連携しやすくする。

## 2. Task Plug-in System

### Goals
- External packages (pyoco-vision, pyoco-ml...) declare tasks via entry points.
- pyoco TaskLoader discovers them automatically via `importlib.metadata.entry_points(group="pyoco.tasks")`.
- Provide docs/template for publishing a plug-in package.

### Proposed Work
1. **Entry point loader**
   - Extend TaskLoader to call `entry_points(group="pyoco.tasks")`, load callables (call-signature: `def register_tasks(registry: TaskRegistry) -> None`), and register tasks into Flow definitions via a provided registry object（`PluginRegistry.task(...)`デコレータ、`registry.add(task)` API を用意）。
   - Handle errors gracefully (misconfigured entry points -> warning) and allow plug-ins to declare metadata（タグ/カテゴリなど）。
2. **Developer guide**
   - `docs/plugins.md`: how to write `pyproject.toml` with `[project.entry-points."pyoco.tasks"]` and tests。例:  
     ```toml
     [project.entry-points."pyoco.tasks"]
     image_classify = "pyoco_vision.entrypoint:register_tasks"
     ```
     ```python
     # pyoco_vision/entrypoint.py
     def register_tasks(registry):
         @registry.task(name="image_classify")
         def image_classify(ctx, image_path: str): ...
     ```
   - Provide minimal skeleton (pyoco-vision example) in repo or gist.
3. **CLI helpers**
   - `pyoco plugins list` to show discovered tasks/packages (optional).

## Timeline / Scope
- v0.5.0 focuses only on these two axes; DSL/engine changes are paused to keep release light-weight.
- Once metrics/API are stable, future versions can add more advanced scheduling or sub-flow features.
